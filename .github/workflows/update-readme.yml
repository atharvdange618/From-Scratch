name: Update GitHub Profile README

on:
  schedule:
    # Runs daily at 00:00 UTC
    - cron: "0 0 * * *"
  push:
    branches:
      - main
    paths:
      - "app/api/posts/**"
      - "lib/models/Post.ts"
  workflow_dispatch: # Allow manual triggers

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout profile repository
        uses: actions/checkout@v4
        with:
          repository: atharvdange618/atharvdange618
          token: ${{ secrets.GH_PAT }}
          path: profile-repo

      - name: Fetch latest blog posts
        id: fetch-posts
        run: |
          response=$(curl -s https://built-from-scratch.vercel.app/api/posts/latest)
          echo "$response" > posts.json

          success=$(echo "$response" | jq -r '.success')
          count=$(echo "$response" | jq -r '.count')

          if [ "$success" != "true" ] || [ "$count" == "0" ]; then
            echo "No posts found"
            exit 0
          fi

          # Start building markdown
          echo "### ðŸ“ Latest Blog Posts" > latest-posts.md
          echo "" >> latest-posts.md

          # Process each post
          echo "$response" | jq -c '.data[]' | while read -r post; do
            title=$(echo "$post" | jq -r '.title')
            url=$(echo "$post" | jq -r '.url')
            category=$(echo "$post" | jq -r '.category')
            publishedDate=$(echo "$post" | jq -r '.publishedDate')
            readingTime=$(echo "$post" | jq -r '.readingTime')
            
            # Format date
            formattedDate=$(date -d "$publishedDate" "+%b %d, %Y" 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%S" "${publishedDate%.*}" "+%b %d, %Y" 2>/dev/null || echo "Recent")
            
            # Get emoji based on category
            case "$category" in
              "Active Projects") emoji="ðŸš€" ;;
              "Completed Projects") emoji="âœ…" ;;
              "Learning Notes") emoji="ðŸ“š" ;;
              "Updates") emoji="ðŸ“¢" ;;
              *) emoji="ðŸ“" ;;
            esac
            
            # Append to file instead of variable
            echo "- ${emoji} [**${title}**](${url}) - ${formattedDate} â€¢ ${readingTime}" >> latest-posts.md
          done

          # Add footer
          echo "" >> latest-posts.md
          echo "âž¡ï¸ [**View all posts**](https://built-from-scratch.vercel.app/blogs)" >> latest-posts.md

      - name: Update README
        run: |
          cd profile-repo

          # Read the latest posts markdown
          latest_posts=$(cat ../latest-posts.md)

          # Update the README file
          awk -v posts="$latest_posts" '
            /<!-- BLOG-POST-LIST:START -->/ {
              print
              print posts
              skip=1
              next
            }
            /<!-- BLOG-POST-LIST:END -->/ {
              skip=0
            }
            !skip
          ' README.md > README-new.md

          mv README-new.md README.md

      - name: Commit and push changes
        run: |
          cd profile-repo

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "chore: update latest blog posts in README [skip ci]"
          git push
